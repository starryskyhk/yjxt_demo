<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" >
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
	<title>分页 - 光年(Light Year Admin)后台管理系统模板</title>
	<link rel="icon" href="favicon.ico" type="image/ico">
	<meta name="keywords" content="LightYear,光年,后台模板,后台管理系统,光年HTML模板">
	<meta name="description" content="LightYear是一个基于Bootstrap v3.3.7的后台管理系统的HTML模板。">
	<meta name="author" content="yinqi">
	<link th:href="@{/css/bootstrap.min.css}" rel="stylesheet">
	<link th:href="@{/css/materialdesignicons.min.css}" rel="stylesheet">
	<link th:href="@{/css/animate.css}" rel="stylesheet">
	<link th:href="@{/css/style.min.css}" rel="stylesheet">
	<link th:href="@{/js/bootstrap-table/bootstrap-table.min.css}" rel="stylesheet">
</head>
<body>
<div class="container-fluid p-t-15">
	<div class="row">
	  
	<div class="col-lg-12">
	  <div class="card">
		 <div class="card-header">
		 	<h4>资源列表</h4>
		 
		         </div>
	    
	    <div class="card-body">
	      
	      <div id="toolbar2" class="toolbar-btn-action">
	        <button type="button" class="btn btn-primary m-r-5 btn-sm" onclick="test()">保存</button>
	      </div>
	      
	      <table class="tree-table"></table>
	    </div>
	  </div>
	</div>
	  
	  
	   
	</div>
</div>
<script type="text/javascript" th:src="@{/js/jquery.min.js}"></script>
<script type="text/javascript" th:src="@{/js/bootstrap.min.js}"></script>
<script type="text/javascript" th:src="@{/js/perfect-scrollbar.min.js}"></script>
<script type="text/javascript" th:src="@{/js/bootstrap-table/bootstrap-table.js}"></script>
<script type="text/javascript" th:src="@{/js/bootstrap-table/bootstrap-table-zh-CN.min.js}"></script>
<!--行内编辑插件-->
<link th:href="@{/js/x-editable/1.5.1/bootstrap3-editable/css/bootstrap-editable.min.css}" rel="stylesheet">
<script type="text/javascript" th:src="@{/js/x-editable/1.5.1/bootstrap3-editable/js/bootstrap-editable.min.js}"></script>
<script type="text/javascript" th:src="@{/js/bootstrap-table/extensions/editable/bootstrap-table-editable.min.js}"></script>

<script type="text/javascript" th:src="@{/js/main.min.js}"></script>
<!--以下是tree-grid的使用示例-->
<link th:href="@{/js/jquery-treegrid/jquery.treegrid.min.css}" rel="stylesheet">
<script type="text/javascript" th:src="@{/js/jquery-treegrid/jquery.treegrid.min.js}"></script>
<script type="text/javascript" th:src="@{/js/bootstrap-table/extensions/treegrid/bootstrap-table-treegrid.min.js}"></script>
<script type="text/javascript" th:src="@{/lib/layer/layer.js}"></script>
<script type="text/javascript" >

	// tree-grid使用
	var $treeTable = $('.tree-table');
	$treeTable.bootstrapTable({
		url: '[[@{/sys/resource}]]',
		idField: 'resourceId',
		uniqueId: 'resourceId',
		dataType: 'json',
		toolbar: '#toolbar2',
		columns: [
			{
				field: 'check',
				checkbox: true
			},
			{
				field: 'name',
				title: '名称'
			},
			{
				field: 'icon',
				title: '图标'
			},
			{
				field: 'url',
				title: '路径'
			},
			{
				field: 'orderNum',
				title: '排序'
			},
			{
				field: 'permission',
				title: '权限值'
			},
			{
				field: 'type',
				title: '类型'
			},
			{
				field: 'operate',
				title: '操作',
				align: 'center',
				events : {
					'click .role-add': function (e, value, row) {
						add(row.parentId);
					},
					'click .role-delete': function (e, value, row) {
						del(row.resourceId);
					},
					'click .role-edit': function (e, value, row) {
						update(row.resourceId);
					}
				},
				formatter: operateFormatter
			}
		],

		treeShowField: 'name',
		parentIdField: 'parentId',

		onResetView: function(data) {
			$treeTable.treegrid({
				initialState: 'collapsed', // 所有节点都折叠
				treeColumn: 1,
				expanderExpandedClass: 'mdi mdi-folder-open',  // 可自定义图标样式
				expanderCollapsedClass: 'mdi mdi-folder',
				onChange: function() {
					$treeTable.bootstrapTable('resetWidth');
				}
			});

			// 只展开树形的第一集节点
			$treeTable.treegrid('getRootNodes').treegrid('expand');
		},
		onCheck: function(row) {
			var datas = $treeTable.bootstrapTable('getData');

			selectChilds(datas, row, 'resourceId', 'parentId', true); // 选择子类

			selectParentChecked(datas, row, 'resourceId', 'parentId'); // 选择父类

			$treeTable.bootstrapTable('load', datas);
		},

		onUncheck: function(row) {
			var datas = $treeTable.bootstrapTable('getData');
			selectChilds(datas, row, 'resourceId', 'parentId', false);
			$treeTable.bootstrapTable('load', datas);
		},
	});

	// 操作按钮
	function operateFormatter(value, row, index) {
		return [
			'<a type="button" class="role-add btn btn-xs btn-default m-r-5" title="编辑" data-toggle="tooltip"><i class="mdi mdi-plus"></i></a>',
			'<a type="button" class="role-edit btn btn-xs btn-default m-r-5" title="修改" data-toggle="tooltip"><i class="mdi mdi-pencil"></i></a>',
			'<a type="button" class="role-delete btn btn-xs btn-default" title="删除" data-toggle="tooltip"><i class="mdi mdi-delete"></i></a>'
		].join('');
	}

	/**
	 * 选中父项时，同时选中子项
	 * @param datas 所有的数据
	 * @param row 当前数据
	 * @param id id 字段名
	 * @param pid 父id字段名
	 */
	function selectChilds(datas,row,id,pid,checked) {
		for(var i in datas){
			if(datas[i][pid] == row[id]){
				datas[i].check=checked;
				selectChilds(datas,datas[i],id,pid,checked);
			};
		}
	}

	function selectParentChecked(datas,row,id,pid){
		for(var i in datas){
			if(datas[i][id] == row[pid]){
				datas[i].check=true;
				selectParentChecked(datas,datas[i],id,pid);
			};
		}
	}

	function add(id) {
		alert(id);
		console.log(id);
		console.log(${id});
		window.location.href = '[[@{/sys/resource/add(parentId=${id})}]]';
	}
	function del(id) {
		layer.confirm(id, {icon: 3, offset: 't'}, function () {
			$.ajax({
				url: '[[@{/sys/resource/{resourceId}(resourceId=${id})}]]' ,
				type: 'delete',
				success: function (response) {
					if (response.code == 0) {
						layer.msg(response.msg, {icon: 1, time: 1000, offset: 't'});
						//跳转到资源管理的初始化页面
						//window.parent.location.href = '${ctx}/sys/resource?parentId=${parent.resourceId}';
					} else {
						layer.alert(response.msg, {icon: 5, offset: 't'});
					}
				}
			})
		})

	}
	function update(id) {
		alert("update 方法 , id = " + id);
	}


	function test() {
		var selRows = $treeTable.bootstrapTable("getSelections");
		if(selRows.length == 0){
			alert("请至少选择一行");
			return;
		}
		console.log(selRows);

		var postData = "";
		$.each(selRows,function(i) {
			postData +=  this.resourceId;
			if (i < selRows.length - 1) {
				postData += "， ";
			}
		});
		alert("你选中行的 id 为："+postData);
	}
</script>
</body>
</html>
